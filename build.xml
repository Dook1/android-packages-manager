<project name="Jimm" default="release">

	<property file="build.properties"/>
	<property name="version.core"  value="${app.build.verision}.${app.build.number}"/>
	<property name="app.short-name" value="apm" />
	<property name="version" value="0.5.1" />
	<property name="version.apm" value="${version}" />
	<property name="name.src" value="src" />
	<property name="name.dest" value="dest" />
	<property name="name.bin" value="bin" />
	<property name="name.build" value="build" />
	<property name="name.builds" value="builds" />
	<property name="name.img" value="img" />
	<property name="name.apm-gui" value="apm-gui" />
	<property name="name.apm-core" value="apm-core" />
	<property name="name.file.icon" value="apm64.png" />

	<property name="app.base" value="${basedir}" />
	<property name="app.prop-default" value="${app.base}/prop-default" />
	<property name="app.icon" value="${app.base}/${name.img}/${name.file.icon}" />

	<property name="app.java.main-class" value="ru.ucoz.megadiablo.android.apm.Runner" />

	<property name="app.lib" value="${basedir}/libs" />

	<property name="app.lib.adb-helper" value="${app.lib}/adb-helper.jar" />
	<property name="app.libs" value="" />

	<property name="app.src" value="${app.base}/${name.src}" />
	<property name="app.src-gui" value="${app.base}/${name.src}-gui" />
	<property name="app.src-core" value="${app.base}/${name.src}-core" />
	<property name="app.src-jtatoo" value="${app.base}/${name.src}-jtatoo" />
	<property name="app.src-data" value="${app.base}/${name.src}-data" />

	<property name="app.build" value="${app.base}/${name.bin}/${name.build}" />
	<property name="app.build.src" value="${app.build}/${name.src}" />
	<property name="app.build.bin" value="${app.build}/${name.bin}" />

	<property name="app.build.jar" value="${app.base}/${name.builds}/${name.apm-gui}" />
	<property name="app.build.jar.name" value="${app.build.jar}/${app.short-name}-${version.apm}.jar" />

	<property name="app.build.zip" value="${app.base}/${name.builds}/${name.apm-gui}" />
	<property name="app.build.zip.name" value="${app.build.zip}/${app.short-name}-${version.apm}.zip" />

	<target name="release" depends="version,compile,build-jar,build-zip,clean">
		<echo>Finished</echo>
	</target>
	<target name="version">
		<echo>GUI  : ${version.apm}</echo>
		<echo>Core : ${version.core}</echo>
	</target>

	<target name="clean">
		<delete dir="${app.build}" />
	</target>

	<target name="create-dir">
		<mkdir dir="${app.build}" />
		<mkdir dir="${app.build.src}" />
		<mkdir dir="${app.build.bin}" />
	</target>

	<target name="copy">
		<copy todir="${app.build.src}" overwrite="true">
			<fileset dir="${app.src-gui}" includes="**/*" />
			<fileset dir="${app.src-core}" includes="**/*" />
			<fileset dir="${app.src-jtatoo}" includes="**/*" />
			<fileset dir="${app.src-data}" includes="**/*" />
		</copy>
	</target>

	<target name="precompile" depends="clean,create-dir,copy">
		<replace dir="${app.build.src}" encoding="UTF-8">
			<replacefilter token="%%VERSION%%" value="${version.apm}" />
			<replacefilter token="%%VERSION_CORE%%" value="${version.core}" />
		</replace>

		<echo>Finished</echo>
	</target>

	<target name="compile" depends="precompile">
		<javac srcdir="${app.build.src}" destdir="${app.build.bin}" classpath="${app.libs}" debug="off" encoding="UTF-8">
		</javac>
	</target>

	<target name="build-jar" depends="">
		<delete file="${app.build.jar.name}" />

		<jar destfile="${app.build.jar.name}">

			<fileset dir="${app.build.bin}" includes="**/*.class" />
			<fileset dir="${app.build.src}" includes="**/*" excludes="**/*.java" />

			<manifest>
				<attribute name="Manifest-Version" value="1.0" />
				<attribute name="Class-Path" value="." />
				<attribute name="Main-Class" value="${app.java.main-class}" />
			</manifest>
		</jar>
	</target>

	<target name="build-zip" depends="">
		<delete file="${app.build.zip.name}" />

		<zip destfile="${app.build.zip.name}">
			<fileset file="${app.build.jar.name}" />
			<fileset file="${app.icon}" />
			<fileset dir="${app.prop-default}" includes="*.prop" />
		</zip>
	</target>

	<target name="obfuscate">
		<taskdef resource="proguard/ant/task.properties" classpath="${basedir}/proguard/proguard.jar" />
		<proguard configuration="${app.base}/proguard.cfg" printseeds="on" printmapping="out.map" renamesourcefileattribute="SourceFile">
			<injar file="${app.build.jar.name}" />
			<outjar file="${app.base}/out.jar" />

			<libraryjar file="${java.home}/lib/rt.jar" />

			<keepattribute name="LineNumberTable" />
			<keepattribute name="SourceFile" />
			<keepattribute name="*Annotation*" />
			<keepclasseswithmembers access="public">
				<method access="public static" type="void" name="main" parameters="java.lang.String[]" />
			</keepclasseswithmembers>

			<keepclasseswithmembernames>
				<method access="native" />
			</keepclasseswithmembernames>

			<keepclassmembers extends="java.lang.Enum">
				<method access="public static" type="**[]" name="values" parameters="" />
				<method access="public static" type="**" name="valueOf" parameters="java.lang.String" />
			</keepclassmembers>

			<keepclassmembers implements="java.io.Serializable">
				<field access="static final" type="long" name="serialVersionUID" />
				<field access="static final" type="java.io.ObjectStreamField[]" name="serialPersistentFields" />
				<method access="private" type="void" name="writeObject" parameters="java.io.ObjectOutputStream" />
				<method access="private" type="void" name="readObject" parameters="java.io.ObjectInputStream" />
				<method type="java.lang.Object" name="writeReplace" parameters="" />
				<method type="java.lang.Object" name="readResolve" parameters="" />
			</keepclassmembers>
		</proguard>
	</target>

</project>
